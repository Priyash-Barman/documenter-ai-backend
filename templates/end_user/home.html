<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() if csrf_token else '' }}">
    <title>Documentor AI | Document Digitization</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --accent-color: #4cc9f0;
            --dark-color: #1a1a2e;
            --light-color: #f8f9fa;
        }

        body {
            background-color: #f5f7fb;
            color: #333;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar {
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 0.8rem 2rem;
        }

        .navbar-brand {
            font-weight: 700;
            color: var(--primary-color);
            font-size: 1.5rem;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
        }

        .dropdown-menu {
            border: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }

        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background-color: white;
        }

        .upload-area:hover {
            border-color: var(--primary-color);
            background-color: rgba(67, 97, 238, 0.05);
        }

        .btn-primary {
            background-color: var(--primary-color);
            border: none;
            padding: 0.5rem 1.5rem;
            border-radius: 8px;
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
        }

        .history-item {
            border-left: 4px solid var(--primary-color);
            transition: all 0.2s;
        }

        .history-item:hover {
            background-color: rgba(67, 97, 238, 0.05);
        }

        .badge {
            padding: 0.35em 0.65em;
            font-weight: 500;
        }

        .model-selector .dropdown-toggle {
            background-color: white;
            color: var(--dark-color);
            border: 1px solid #e5e7eb;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 500;
        }

        .model-selector .dropdown-toggle:hover {
            background-color: #f9fafb;
        }

        .file-preview {
            max-height: 200px;
            object-fit: contain;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .result-image {
            max-height: 300px;
            object-fit: contain;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid #e5e7eb;
        }

        .modal-document-image {
            max-height: 400px;
            object-fit: contain;
            border-radius: 8px;
            margin: 0 auto;
            display: block;
        }

        .pagination .page-item.active .page-link {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .pagination .page-link {
            color: var(--primary-color);
        }
    </style>
</head>
<body>
    <!-- Header/Navbar -->
    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container-fluid">
            <!-- Left side - Brand and Model Selector -->
            <div class="d-flex align-items-center">
                <a class="navbar-brand me-4" href="#">
                    <i class="bi bi-file-earmark-text-fill me-2"></i>DocumentorAI
                </a>

                {% if user %}
                <div class="model-selector me-3">
                    <div class="dropdown">
                        <button class="btn dropdown-toggle" type="button" id="modelDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-robot me-2"></i>Available Models
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="modelDropdown">
                            <li><h6 class="dropdown-header">OCR Models</h6></li>
                            <li><a class="dropdown-item" href="#">Tesseract OCR</a></li>
                            <li><a class="dropdown-item" href="#">Google Vision</a></li>
                            <li><a class="dropdown-item" href="#">AWS Textract</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><h6 class="dropdown-header">Document Types</h6></li>
                            <li><a class="dropdown-item" href="#">Invoices</a></li>
                            <li><a class="dropdown-item" href="#">Receipts</a></li>
                            <li><a class="dropdown-item" href="#">Contracts</a></li>
                        </ul>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Right side - User Profile -->
            {% if user %}
            <div class="dropdown">
                <a href="#" class="d-flex align-items-center text-decoration-none dropdown-toggle" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <img src="https://ui-avatars.com/api/?name={{ user.full_name }}&background=4361ee&color=fff" alt="User" class="user-avatar">
                    <span class="d-none d-md-inline">{{ user.full_name }}</span>
                </a>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                    <li><h6 class="dropdown-header">Account</h6></li>
                    <li><a class="dropdown-item" href="#"><i class="bi bi-person me-2"></i>Profile</a></li>
                    <li><a class="dropdown-item" href="#"><i class="bi bi-box me-2"></i>My Apps</a></li>
                    <li><a class="dropdown-item" href="#"><i class="bi bi-credit-card me-2"></i>Subscription</a></li>
                    <li><a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i>Settings</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><div class="px-3 py-1">
                        <small class="text-muted">Logged in as</small>
                        <div class="fw-bold">{{ user.email }}</div>
                    </div></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="/logout"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                </ul>
            </div>
            {% else %}
            <a href="/login" class="btn btn-primary px-4">Login</a>
            {% endif %}
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid py-4">
        <div class="row">
            <!-- Main Content Area -->
            <div class="col-lg-8 mx-auto">
                {% if user %}
                <!-- Upload Section -->
                <div class="card mb-4">
                    <div class="card-body p-4">
                        <h5 class="card-title mb-4"><i class="bi bi-cloud-arrow-up-fill me-2"></i>Upload Document</h5>
                        <div class="upload-area" id="uploadArea">
                            <div class="mb-3">
                                <i class="bi bi-file-earmark-arrow-up" style="font-size: 2.5rem; color: var(--primary-color);"></i>
                            </div>
                            <h5 class="mb-2">Drag & drop your document here</h5>
                            <p class="text-muted mb-3">or click to browse files</p>
                            <input type="file" id="documentUpload" accept="image/*,.pdf" class="d-none">
                            <button class="btn btn-primary px-4" onclick="document.getElementById('documentUpload').click()">
                                <i class="bi bi-folder2-open me-2"></i>Select File
                            </button>
                        </div>

                        <!-- Preview Section (hidden by default) -->
                        <div class="mt-4 d-none" id="previewSection">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="mb-3">Original Document</h6>
                                    <img src="" alt="Document Preview" class="img-fluid file-preview" id="originalPreview">
                                    <div class="text-center mt-2">
                                        <button class="btn btn-sm btn-outline-secondary" id="downloadOriginalBtn" disabled>
                                            <i class="bi bi-download me-1"></i>Download Original
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="mb-3">Digitized Output</h6>
                                    <div id="digitizedOutput">
                                        <img src="" alt="Digitized Output" class="img-fluid result-image d-none" id="resultPreview">
                                        <div class="bg-light p-3 rounded" id="textOutput">
                                            <p class="text-muted mb-0">Digitized content will appear here...</p>
                                        </div>
                                    </div>
                                    <div class="text-center mt-2">
                                        <button class="btn btn-sm btn-outline-primary d-none" id="downloadResultBtn">
                                            <i class="bi bi-download me-1"></i>Download Result
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-end mt-3">
                                <button class="btn btn-primary me-2" id="convertBtn">
                                    <i class="bi bi-magic me-2"></i>Convert Now
                                </button>
                                <button class="btn btn-outline-secondary" id="cancelBtn">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Conversion History -->
                <div class="card">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="card-title mb-0"><i class="bi bi-clock-history me-2"></i>Recent Conversions</h5>
                            <button class="btn btn-sm btn-outline-secondary">
                                <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                            </button>
                        </div>

                        <div class="list-group mb-3">
                            <!-- Sample history items - these would be dynamically generated in a real app -->
                            <div class="list-group-item border-0 rounded mb-2 p-3 history-item">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h6 class="mb-1">invoice_2023.pdf</h6>
                                        <small class="text-muted">Converted 2 hours ago | Tesseract OCR</small>
                                    </div>
                                    <div>
                                        <span class="badge bg-success bg-opacity-10 text-success">Completed</span>
                                        <button class="btn btn-sm btn-outline-primary ms-2" data-bs-toggle="modal" data-bs-target="#historyModal"
                                                onclick="showHistoryItem('invoice_2023.pdf', '2 hours ago', 'Tesseract OCR', 'invoice.jpg', 'invoice_digitized.jpg')">
                                            View
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="list-group-item border-0 rounded mb-2 p-3 history-item">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h6 class="mb-1">receipt_june.jpg</h6>
                                        <small class="text-muted">Converted yesterday | Google Vision</small>
                                    </div>
                                    <div>
                                        <span class="badge bg-success bg-opacity-10 text-success">Completed</span>
                                        <button class="btn btn-sm btn-outline-primary ms-2" data-bs-toggle="modal" data-bs-target="#historyModal"
                                                onclick="showHistoryItem('receipt_june.jpg', 'yesterday', 'Google Vision', 'receipt.jpg', 'receipt_digitized.jpg')">
                                            View
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="list-group-item border-0 rounded mb-2 p-3 history-item">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h6 class="mb-1">contract_agreement.png</h6>
                                        <small class="text-muted">Converted 3 days ago | AWS Textract</small>
                                    </div>
                                    <div>
                                        <span class="badge bg-success bg-opacity-10 text-success">Completed</span>
                                        <button class="btn btn-sm btn-outline-primary ms-2" data-bs-toggle="modal" data-bs-target="#historyModal"
                                                onclick="showHistoryItem('contract_agreement.png', '3 days ago', 'AWS Textract', 'contract.png', 'contract_digitized.png')">
                                            View
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="list-group-item border-0 rounded p-3 history-item">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h6 class="mb-1">scan_document.pdf</h6>
                                        <small class="text-muted">Converted 1 week ago | Tesseract OCR</small>
                                    </div>
                                    <div>
                                        <span class="badge bg-success bg-opacity-10 text-success">Completed</span>
                                        <button class="btn btn-sm btn-outline-primary ms-2" data-bs-toggle="modal" data-bs-target="#historyModal"
                                                onclick="showHistoryItem('scan_document.pdf', '1 week ago', 'Tesseract OCR', 'scan.jpg', 'scan_digitized.jpg')">
                                            View
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Pagination -->
                        <nav aria-label="History pagination">
                            <ul class="pagination justify-content-center">
                                <li class="page-item disabled">
                                    <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
                                </li>
                                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                <li class="page-item"><a class="page-link" href="#">2</a></li>
                                <li class="page-item"><a class="page-link" href="#">3</a></li>
                                <li class="page-item">
                                    <a class="page-link" href="#">Next</a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
                {% else %}
                <!-- Not logged in state -->
                <div class="card shadow-sm">
                    <div class="card-body text-center py-5">
                        <div class="alert alert-warning mb-4">
                            <h4 class="alert-heading">Authentication Required</h4>
                            <p>Please login to access the document digitization features.</p>
                        </div>
                        <a href="/login" class="btn btn-primary px-4">
                            <i class="bi bi-box-arrow-in-right me-2"></i>Login to Continue
                        </a>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- History Item Modal -->
    <div class="modal fade" id="historyModal" tabindex="-1" aria-labelledby="historyModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="historyModalLabel">Conversion Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p class="mb-1"><strong>Filename:</strong> <span id="modalFilename">-</span></p>
                            <p class="mb-1"><strong>Date:</strong> <span id="modalDate">-</span></p>
                            <p class="mb-1"><strong>Model:</strong> <span id="modalModel">-</span></p>
                            <p class="mb-1"><strong>Status:</strong> <span class="badge bg-success bg-opacity-10 text-success">Completed</span></p>
                        </div>
                        <div class="col-md-6 text-end">
                            <button class="btn btn-primary" id="downloadAllBtn">
                                <i class="bi bi-download me-2"></i>Download All
                            </button>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="mb-3">Original Document</h6>
                            <img src="" alt="Original Document" class="modal-document-image" id="modalOriginalImage">
                            <div class="text-center mt-2">
                                <button class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-download me-1"></i>Download Original
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="mb-3">Digitized Result</h6>
                            <img src="" alt="Digitized Result" class="modal-document-image" id="modalResultImage">
                            <div class="text-center mt-2">
                                <button class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-download me-1"></i>Download Result
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Basic file upload preview functionality
        document.getElementById('documentUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('originalPreview').src = event.target.result;
                    document.getElementById('uploadArea').classList.add('d-none');
                    document.getElementById('previewSection').classList.remove('d-none');
                }
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('cancelBtn').addEventListener('click', function() {
            document.getElementById('documentUpload').value = '';
            document.getElementById('uploadArea').classList.remove('d-none');
            document.getElementById('previewSection').classList.add('d-none');
        });

        // Simulate conversion process
        document.getElementById('convertBtn').addEventListener('click', async function() {
            const convertBtn = document.getElementById('convertBtn');
            const originalText = convertBtn.innerHTML;
            const fileInput = document.getElementById('documentUpload');
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a file first');
                return;
            }

            convertBtn.disabled = true;
            convertBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Processing...';

            try {
                // Create FormData and append the file
                const formData = new FormData();
                formData.append('image', file);
                formData.append('model', 'tesseract'); // Default model, can be changed from UI

                // Make API call
                const response = await fetch('/convert', {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
                    },
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}`);
                }

                const result = await response.json();

                // Display the result
                document.getElementById('textOutput').classList.add('d-none');
                document.getElementById('resultPreview').classList.remove('d-none');
                document.getElementById('resultPreview').src = `data:image/png;base64,${result.digitized_image}`;

                // Show the download button for result
                document.getElementById('downloadResultBtn').classList.remove('d-none');

                // Store the result data for download
                document.getElementById('downloadResultBtn').dataset.filename = result.filename;
                document.getElementById('downloadResultBtn').dataset.imageData = result.digitized_image;

            } catch (error) {
                console.error('Conversion error:', error);
                alert('Conversion failed. Please try again.');
            } finally {
                convertBtn.disabled = false;
                convertBtn.innerHTML = originalText;
            }
        });

        // Add proper download functionality
        document.getElementById('downloadOriginalBtn').addEventListener('click', function() {
            const file = document.getElementById('documentUpload').files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                const a = document.createElement('a');
                a.href = url;
                a.download = file.name || 'document';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        });

        document.getElementById('downloadResultBtn').addEventListener('click', function() {
            const btn = this;
            const filename = btn.dataset.filename || 'digitized_document.png';
            const imageData = btn.dataset.imageData;

            if (imageData) {
                const link = document.createElement('a');
                link.href = `data:image/png;base64,${imageData}`;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        });

        // Drag and drop functionality
        const uploadArea = document.getElementById('uploadArea');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            uploadArea.classList.add('border-primary');
            uploadArea.style.backgroundColor = 'rgba(67, 97, 238, 0.05)';
        }

        function unhighlight() {
            uploadArea.classList.remove('border-primary');
            uploadArea.style.backgroundColor = '';
        }

        uploadArea.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            document.getElementById('documentUpload').files = files;

            // Trigger the change event
            const event = new Event('change');
            document.getElementById('documentUpload').dispatchEvent(event);
        }

        // History modal functionality
        function showHistoryItem(filename, date, model, originalImg, resultImg) {
            document.getElementById('modalFilename').textContent = filename;
            document.getElementById('modalDate').textContent = date;
            document.getElementById('modalModel').textContent = model;

            // Set images (in a real app, these would be the actual image URLs)
            document.getElementById('modalOriginalImage').src = `https://via.placeholder.com/600x800/ffffff/333333?text=${encodeURIComponent(originalImg)}`;
            document.getElementById('modalResultImage').src = `https://via.placeholder.com/600x800/4361ee/ffffff?text=${encodeURIComponent(resultImg)}`;

            // Set download buttons (in a real app, these would link to actual files)
            document.querySelector('#historyModal .modal-body .btn-outline-primary').onclick = function() {
                alert(`Downloading original file: ${originalImg}`);
            };

            document.querySelectorAll('#historyModal .modal-body .btn-outline-primary')[1].onclick = function() {
                alert(`Downloading result file: ${resultImg}`);
            };

            document.getElementById('downloadAllBtn').onclick = function() {
                alert(`Downloading ZIP file containing ${originalImg} and ${resultImg}`);
            };
        }
    </script>
</body>
</html>